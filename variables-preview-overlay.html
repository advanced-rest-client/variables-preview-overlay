<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/legacy/class.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">
<dom-module id="variables-preview-overlay">
  <template>
    <style>
    :host {
      display: block;
      background-color: var(--variables-preview-overlay-background-color, inherit);
      color: var(--variables-preview-overlay-color, var(--primary-text-color));

      @apply --arc-font-body1;
      @apply --shadow-elevation-16dp;
      @apply --variables-preview-overlay;
    }

    h2 {
      position: relative;
      margin-top: 20px;
      padding: 0 24px;

      @apply --arc-font-title;
      @apply --variables-preview-overlay-title;
    }

    .container {
      @apply --layout-vertical;
      max-height: inherit;
    }

    .content {
      overflow: auto;
      @apply --layout-flex;
      max-height: inherit;
      height: 100vh;
      flex-basis: initial;
      -webkit-flex-basis: initial;
      @apply --variables-preview-overlay-container;
    }

    .buttons {
      position: relative;
      padding: 8px 8px 8px 24px;
      margin: 0;
      color: var(--variables-preview-overlay-button-color, var(--primary-color));
      @apply --layout-horizontal;
      @apply --layout-end-justified;
    }

    .list {
      list-style: none;
      word-break: break-all;
    }

    .list,
    .no-vars {
      margin-top: 24px;
      margin-bottom: 24px;
      padding: 0 24px;
      min-width: 300px;
    }

    .var-name {
      color: rgba(0, 0, 0, .54);
      margin-right: 16px;
      display: inline-block;
    }

    .var-value {
      color: rgba(0, 0, 0, .87);
      display: inline-block;
    }

    li span {
      text-decoration: line-through;
    }

    li[data-enabled] span {
      text-decoration: none;
    }

    paper-button {
      cursor: pointer;
    }
    </style>
    <div class="container">
      <div class="content">
        <template is="dom-if" if="[[hasAppVariables]]">
          <h2>Variables for [[environment]]</h2>
          <ul class="list app-vars" aria-role="list">
            <template is="dom-repeat" items="[[variables]]" sort="_varSort" observe="enabled" id="repeater">
              <li data-enabled$="[[item.enabled]]" aria-role="listitem">
                <span class="var-name">[[item.variable]]</span>
                <span class="var-value">[[item.value]]</span>
              </li>
            </template>
          </ul>
        </template>
        <template is="dom-if" if="[[hasSysVariables]]">
          <h2>System variables</h2>
          <ul class="list sys-vars" aria-role="list">
            <template is="dom-repeat" items="[[systemVariables]]">
              <li aria-role="listitem" data-enabled>
                <span class="var-name">[[item.variable]]</span>
                <span class="var-value">[[item.value]]</span>
              </li>
            </template>
          </ul>
        </template>
        <template is="dom-if" if="[[!hasVariables]]">
          <p class="no-vars">Variables list is empty for this environment</p>
        </template>
      </div>
      <div class="buttons">
        <paper-button on-tap="_fireEdit">Edit variables</paper-button>
      </div>
    </div>
  </template>
  <script>
  /**
   * An element to display quick preview of variables values for selected
   * environment.
   *
   * The element works with
   * [variables-manager](https://github.com/advanced-rest-client/variables-manager/)
   * that provides the events API to get information about environemnts and variables.
   *
   * The element displays an overlay controlled by `Polymer.IronOverlayBehavior`
   * with list of variables associated with current environment.
   *
   * It listens for `variables-list-changed` custom event dispatched by the
   * `variables-manager`.
   * If the event cannot be send by the application then set `variables` and
   * `environemnt` properties to the corresponding values.
   *
   * ### Example
   *
   * ```html
   * <variables-preview-overlay id="overlay"></variables-preview-overlay>
   * ```
   * ```javascript
   * document.getElementById('overlay').positionTarget = target; // HTML element
   * ```
   *
   * ### Styling
   *
   * `<variables-preview-overlay>` provides the following custom properties and
   * mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--variables-preview-overlay` | Mixin applied to the element | `{}`
   * `--variables-preview-overlay-background-color` | Background color of the oberlay | `inherit`
   * `--variables-preview-overlay-dialog-color` | Overlay foreground color | `--primary-text-color`
   * `--variables-preview-overlay-title` | Mixin applied to the title element | `{}`
   *
   * @memberof UiElements
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @appliesMixin Polymer.IronOverlayBehavior
   */
  class VariablesPreviewOverlay extends
    Polymer.mixinBehaviors([Polymer.IronOverlayBehavior], Polymer.Element) {
    static get is() { return 'variables-preview-overlay';}
    static get properties() {
      return {
        /**
         * List of variables to display on the list.
         * It is updated automatically for `variables-list-changed` event fired
         * by the `variables-manager` element.
         */
        variables: {
          type: Array,
          observer: '_variablesChanged'
        },
        /**
         * List of system variables to display.
         */
        systemVariables: {
          type: Array,
          observer: '_sysVariablesChanged'
        },
        /**
         * Currently selected environment name
         */
        environment: String,
        /**
         * Computed value, true if the environment has any variable
         */
        hasVariables: {
          type: Boolean,
          readOnly: true,
          value: false,
          computed: '_computeHasVariables(hasAppVariables, hasSysVariables)'
        },
        /**
         * Computed value, true if the element has application variables
         */
        hasAppVariables: {
          type: Boolean,
          readOnly: true,
          value: false
        },
        /**
         * Computed value, true if the element has system variables
         */
        hasSysVariables: {
          type: Boolean,
          readOnly: true,
          value: false
        }
      };
    }

    constructor() {
      super();
      this._varsChanged = this._varsChanged.bind(this);
      this._varDeletedHandler = this._varDeletedHandler.bind(this);
      this._varUpdateHandler = this._varUpdateHandler.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      window.addEventListener('variables-list-changed', this._varsChanged);
      window.addEventListener('variable-deleted', this._varDeletedHandler);
      window.addEventListener('variable-updated', this._varUpdateHandler);

      if (!this.variables) {
        Polymer.RenderStatus.afterNextRender(this, () => {
          this.refresh();
        });
      }
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('variables-list-changed', this._varsChanged);
      window.removeEventListener('variable-deleted', this._varDeletedHandler);
      window.removeEventListener('variable-updated', this._varUpdateHandler);
    }

    /**
     * Refreshes the list of variables on demand.
     *
     * @return {[type]} [description]
     */
    refresh() {
      this._refreshVariables();
      this._refreshEnvironment();
    }
    /**
    * Dispatches `variable-list` custom event to ask variables manager
    * for list of variables.
     */
    _refreshVariables() {
      const e = new CustomEvent('variable-list', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {}
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return;
      }
      this._processVariablesList(e.detail.value);
    }
    /**
     * Dispatches `environment-current` custom event to ask variables manager
     * for current environment.
     */
    _refreshEnvironment() {
      const e = new CustomEvent('environment-current', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {}
      });
      this.dispatchEvent(e);
      this.set('environment', e.detail.value);
    }
    /**
     * Processes list of variables.
     * Sets `variables` and `systemVariables` properties.
     *
     * @param {Array} variables List of variables received from the variables
     * manager.
     */
    _processVariablesList(variables) {
      if (!variables || !variables.length) {
        this.set('variables', variables);
        this.set('systemVariables', variables);
        return;
      }
      variables = variables.map((item) => Object.assign({}, item));
      const sysVars = [];
      for (let i = variables.length - 1; i >= 0; i--) {
        const copy = Object.assign({}, variables[i]);
        if (copy.sysVar) {
          sysVars.push(copy);
          variables.splice(i, 1);
        } else {
          variables[i] = copy;
        }
      }
      const variablesResult = variables.length ? variables : undefined;
      const sysVarsResult = sysVars.length ? sysVars : undefined;
      this.set('variables', variablesResult);
      this.set('systemVariables', sysVarsResult);
    }

    _varsChanged(e) {
      this._processVariablesList(e.detail.value);
      this.environment = e.detail.environment;
    }

    _varSort(a, b) {
      if (a.enabled === b.enabled) {
        return 0;
      }
      if (a.enabled < b.enabled) {
        return 1;
      }
      return -1;
    }
    /**
     * Computes value of `hasSysVariables` property.
     * Sets true if the element has system variables to display.
     *
     * @param {?Array} value Application defined variables
     */
    _variablesChanged(value) {
      if (!value || !value.length) {
        if (this.hasAppVariables) {
          this._setHasAppVariables(false);
        }
      } else {
        if (!this.hasAppVariables) {
          this._setHasAppVariables(true);
        }
      }
    }
    /**
     * Computes value of `hasSysVariables` property.
     * Sets true if the element has system variables to display.
     *
     * @param {?Array} value System variables.
     */
    _sysVariablesChanged(value) {
      if (!value || !value.length) {
        if (this.hasSysVariables) {
          this._setHasSysVariables(false);
        }
      } else {
        if (!this.hasSysVariables) {
          this._setHasSysVariables(true);
        }
      }
    }
    /**
     * Computes if the element has any variables to display.
     *
     * @param {Boolean} appVars Value of `hasAppVariables` property
     * @param {Boolean} sysVars Value of `hasSysVariables` property
     * @return {Boolean} True if either app or system variables are set.
     */
    _computeHasVariables(appVars, sysVars) {
      return appVars || sysVars;
    }

    _fireEdit() {
      this.dispatchEvent(new CustomEvent('open-variables-editor', {
        bubbles: true,
        composed: true
      }));
      this.opened = false;
    }

    // Handler for the `variable-deleted` event.
    _varDeletedHandler(e) {
      if (e.cancelable || !this.variables) {
        return;
      }
      const id = e.detail.value;
      const index = this.variables.findIndex((item) => item._id === id);
      if (!~index) {
        return;
      }
      this.splice('variables', index, 1);
    }

    // Handler for the `variable-updated` event.
    _varUpdateHandler(e) {
      if (e.cancelable) {
        return;
      }
      const env = e.detail.value;
      if (!this.variables) {
        this.set('variables', [env]);
        return;
      }
      let index = this.variables.findIndex((item) => item._id === env._id);
      if (index === -1) {
        // Here's a trick. When adding new variable it is not saved yet
        // and we should check for a var with the same name.
        index = this.variables.findIndex((item) => (!item._id && item.variable === env.variable));
        if (index === -1) {
          this.push('variables', env);
        }
      }
      if (~index) {
        this.set(['variables', index], env);
      }
    }
    /**
     * Fired when the user requested to edit variables for selected environemnt.
     *
     * @event open-variables-editor
     */
  }
  window.customElements.define(VariablesPreviewOverlay.is, VariablesPreviewOverlay);
  </script>
</dom-module>
